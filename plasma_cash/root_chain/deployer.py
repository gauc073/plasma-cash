import json
import os

from solc import compile_standard
from web3.auto import w3

from plasma_cash.config import plasma_config

OWN_DIR = os.path.dirname(os.path.realpath(__file__))


class Deployer(object):

    def get_dirs(self, path):
        abs_contract_path = os.path.realpath(os.path.join(OWN_DIR, 'contracts'))

        extra_args = []
        for r, d, f in os.walk(abs_contract_path):
            for file in f:
                extra_args.append([file, [os.path.realpath(os.path.join(r, file))]])

        contracts = {}
        for contract in extra_args:
            contracts[contract[0]] = {'urls': contract[1]}
        path = '{}/{}'.format(abs_contract_path, path)
        return path, contracts

    def compile_contract(self, path, args=()):
        file_name = path.split('/')[1]
        contract_name = file_name.split('.')[0]
        path, contracts = self.get_dirs(path)
        # compiled_sol = compile_standard({
        #     'language': 'Solidity',
        #     'sources': {**{path.split('/')[-1]: {'urls': [path]}}, **contracts},
        #     'settings': {'outputSelection': {"*": {"*": ['abi', 'metadata', 'evm.bytecode']}}}
        # }, allow_paths=OWN_DIR + "/contracts")
        # abi = compiled_sol['contracts'][file_name][contract_name]['abi']
        # bytecode = compiled_sol['contracts'][file_name][contract_name]['evm']['bytecode']['object']

        abi = json.loads('[{"constant": false, "inputs": [{"name": "prevTx", "type": "bytes"}, {"name": "prevTxProof", "type": "bytes"}, {"name": "prevTxBlkNum", "type": "uint256"}, {"name": "tx", "type": "bytes"}, {"name": "txProof", "type": "bytes"}, {"name": "txBlkNum", "type": "uint256"}], "name": "startExit", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function"}, {"constant": false, "inputs": [{"name": "blkRoot", "type": "bytes32"}, {"name": "blknum", "type": "uint256"}, {"name": "isDepositBlock", "type": "bool"}, {"name": "depositTx", "type": "bytes"}, {"name": "depositTxProof", "type": "bytes"}], "name": "submitBlock", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function"}, {"constant": true, "inputs": [], "name": "depositCount", "outputs": [{"name": "", "type": "uint256"}], "payable": false, "stateMutability": "view", "type": "function"}, {"constant": true, "inputs": [{"name": "", "type": "uint256"}], "name": "exits", "outputs": [{"name": "hasValue", "type": "bool"}, {"name": "exitTime", "type": "uint256"}, {"name": "exitTxBlkNum", "type": "uint256"}, {"name": "exitTx", "type": "bytes"}, {"name": "txBeforeExitTxBlkNum", "type": "uint256"}, {"name": "txBeforeExitTx", "type": "bytes"}, {"name": "owner", "type": "address"}], "payable": false, "stateMutability": "view", "type": "function"}, {"constant": false, "inputs": [{"name": "uid", "type": "uint256"}], "name": "abortDeposit", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function"}, {"constant": false, "inputs": [ {"name": "tx", "type": "bytes"}, {"name": "txProof", "type": "bytes"}, {"name": "txBlkNum", "type": "uint256"}], "name": "startDepositExit", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function"}, {"constant": false, "inputs": [{"name": "currency", "type": "address"}, {"name": "amount", "type": "uint256"}], "name": "deposit", "outputs": [{"name": "", "type": "uint256"}], "payable": true, "stateMutability": "payable", "type": "function"}, {"constant": false, "inputs": [{"name": "uid", "type": "uint256"}, {"name": "challengeTx", "type": "bytes"}, {"name": "proof", "type": "bytes"}, {"name": "blkNum", "type": "uint256"}], "name": "challengeExit", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function"}, {"constant": false, "inputs": [{"name": "uid", "type": "uint256"}, {"name": "challengeTx", "type": "bytes"}, {"name": "respondTx", "type": "bytes"}, {"name": "proof", "type": "bytes"}, {"name": "blkNum", "type": "uint256"}], "name": "respondChallengeExit", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function"}, {"constant": true, "inputs": [], "name": "currentBlkNum", "outputs": [{"name": "", "type": "uint256"}], "payable": false, "stateMutability": "view", "type": "function"}, {"constant": true, "inputs": [{"name": "", "type": "uint256"}], "name": "wallet", "outputs": [{"name": "hasValue", "type": "bool"}, {"name": "isConfirmed", "type": "bool"}, {"name": "amount", "type": "uint256"}, {"name": "depositor", "type": "address"}], "payable": false, "stateMutability": "view", "type": "function"}, {"constant": false, "inputs": [{"name": "uid", "type": "uint256"}], "name": "finalizeExit", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function"}, {"constant": true, "inputs": [], "name": "authority", "outputs": [{"name": "", "type": "address"}], "payable": false, "stateMutability": "view", "type": "function"}, {"constant": true, "inputs": [{"name": "", "type": "uint256"}, {"name": "", "type": "uint256"}], "name": "challenges", "outputs": [{"name": "hasValue", "type": "bool"}, {"name": "challengeTx", "type": "bytes"}, {"name": "challengeTxBlkNum", "type": "uint256"}], "payable": false, "stateMutability": "view", "type": "function"}, {"constant": false, "inputs": [{"name": "uid", "type": "uint256"}, {"name": "challengeTx", "type": "bytes"}], "name": "isChallengeExisted", "outputs": [{"name": "", "type": "bool"}], "payable": false, "stateMutability": "nonpayable", "type": "function"}, {"constant": true, "inputs": [{"name": "", "type": "uint256"}], "name": "childChain", "outputs": [{"name": "", "type": "bytes32"}], "payable": false, "stateMutability": "view", "type": "function"}, {"inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor"}, {"anonymous": false, "inputs": [{"indexed": false, "name": "depositor", "type": "address"}, {"indexed": false, "name": "amount", "type": "uint256"}, {"indexed": false, "name": "uid", "type": "uint256"}], "name": "Deposit", "type": "event"}]')
        bytecode = "608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600060018190555060006002819055506135bf806100706000396000f3006080604052600436106100e6576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806304675c65146100eb578063255548661461023a5780632dfdf0b51461030d578063342de1791461033857806334d20a0a1461049d578063478b5f91146104ca57806347e7ef24146105835780634a2ee198146105d75780638b5931831461069a5780638c1cdd5d146107a3578063a2781335146107ce578063b427f7ec14610858578063bf7e214f14610885578063dd9e8de9146108dc578063de30fa391461099e578063f95643b114610a29575b600080fd5b3480156100f757600080fd5b50610238600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050610a72565b005b34801561024657600080fd5b5061030b600480360381019080803560001916906020019092919080359060200190929190803515159060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610e13565b005b34801561031957600080fd5b50610322610fc8565b6040518082815260200191505060405180910390f35b34801561034457600080fd5b5061036360048036038101908080359060200190929190505050610fce565b604051808815151515815260200187815260200186815260200180602001858152602001806020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001838103835287818151815260200191508051906020019080838360005b838110156103f55780820151818401526020810190506103da565b50505050905090810190601f1680156104225780820380516001836020036101000a031916815260200191505b50838103825285818151815260200191508051906020019080838360005b8381101561045b578082015181840152602081019050610440565b50505050905090810190601f1680156104885780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b3480156104a957600080fd5b506104c86004803603810190808035906020019092919050505061116d565b005b3480156104d657600080fd5b50610581600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192908035906020019092919050505061129d565b005b6105c1600480360381019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050611521565b6040518082815260200191505060405180910390f35b3480156105e357600080fd5b5061069860048036038101908080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050611788565b005b3480156106a657600080fd5b506107a160048036038101908080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050611c2b565b005b3480156107af57600080fd5b506107b8611e18565b6040518082815260200191505060405180910390f35b3480156107da57600080fd5b506107f960048036038101908080359060200190929190505050611e1e565b6040518085151515158152602001841515151581526020018381526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200194505050505060405180910390f35b34801561086457600080fd5b5061088360048036038101908080359060200190929190505050611e88565b005b34801561089157600080fd5b5061089a612020565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156108e857600080fd5b506109116004803603810190808035906020019092919080359060200190929190505050612045565b604051808415151515815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b83811015610961578082015181840152602081019050610946565b50505050905090810190601f16801561098e5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b3480156109aa57600080fd5b50610a0f60048036038101908080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050612130565b604051808215151515815260200191505060405180910390f35b348015610a3557600080fd5b50610a546004803603810190808035906020019092919050505061215f565b60405180826000191660001916815260200191505060405180910390f35b610a7a613354565b610a82613354565b600080600080610a918c612177565b9550610a9c89612177565b945084600001518a141515610ab057600080fd5b84602001518660200151141515610ac657600080fd5b84604001518660400151141515610adc57600080fd5b846080015173ffffffffffffffffffffffffffffffffffffffff16866060015173ffffffffffffffffffffffffffffffffffffffff16141515610b1e57600080fd5b846060015173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610b5c57600080fd5b8b6040518082805190602001908083835b602083101515610b925780518252602082019150602081019050602083039250610b6d565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390209350600360008b8152602001908152602001600020549250886040518082805190602001908083835b602083101515610c0d5780518252602082019150602081019050602083039250610be8565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020915060036000888152602001908152602001600020549050610c718660200151848d8760001916612283909392919063ffffffff16565b1515610c7c57600080fd5b610c9b8560200151828a8560001916612283909392919063ffffffff16565b1515610ca657600080fd5b600560008660200151815260200190815260200160002060000160009054906101000a900460ff16151515610cda57600080fd5b60e06040519081016040528060011515815260200162127500420181526020018881526020018a81526020018b81526020018d81526020013373ffffffffffffffffffffffffffffffffffffffff16815250600560008760200151815260200190815260200160002060008201518160000160006101000a81548160ff02191690831515021790555060208201518160010155604082015181600201556060820151816003019080519060200190610d939291906133b0565b506080820151816004015560a0820151816005019080519060200190610dba9291906133b0565b5060c08201518160060160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550905050505050505050505050505050565b610e1b613354565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610e7857600080fd5b8415610f7f57610e8784612177565b9150836040518082805190602001908083835b602083101515610ebf5780518252602082019150602081019050602083039250610e9a565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390209050600460008360200151815260200190815260200160002060000160009054906101000a900460ff161515610f2157600080fd5b610f40826020015188858460001916612283909392919063ffffffff16565b1515610f4b57600080fd5b6001600460008460200151815260200190815260200160002060000160016101000a81548160ff0219169083151502179055505b85600160025401141515610f9257600080fd5b86600360008881526020019081526020016000208160001916905550600160026000828254019250508190555050505050505050565b60015481565b60056020528060005260406000206000915090508060000160009054906101000a900460ff1690806001015490806002015490806003018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156110995780601f1061106e57610100808354040283529160200191611099565b820191906000526020600020905b81548152906001019060200180831161107c57829003601f168201915b505050505090806004015490806005018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561113d5780601f106111125761010080835404028352916020019161113d565b820191906000526020600020905b81548152906001019060200180831161112057829003601f168201915b5050505050908060060160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905087565b6004600082815260200190815260200160002060000160019054906101000a900460ff1615151561119d57600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166004600083815260200190815260200160002060020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614151561120d57600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc670de0b6b3a76400006004600085815260200190815260200160002060010154029081150290604051600060405180830381858888f19350505050158015611273573d6000803e3d6000fd5b506004600082815260200190815260200160002060000160006101000a81549060ff021916905550565b6112a5613354565b6000806112b186612177565b9250600083600001511415156112c657600080fd5b826060015173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561130457600080fd5b856040518082805190602001908083835b60208310151561133a5780518252602082019150602081019050602083039250611315565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902091506003600085815260200190815260200160002054905061139e836020015182878560001916612283909392919063ffffffff16565b15156113a957600080fd5b600560008460200151815260200190815260200160002060000160009054906101000a900460ff161515156113dd57600080fd5b60e060405190810160405280600115158152602001621275004201815260200185815260200187815260200160008152602001602060405190810160405280600081525081526020013373ffffffffffffffffffffffffffffffffffffffff16815250600560008560200151815260200190815260200160002060008201518160000160006101000a81548160ff021916908315150217905550602082015181600101556040820151816002015560608201518160030190805190602001906114a79291906133b0565b506080820151816004015560a08201518160050190805190602001906114ce9291906133b0565b5060c08201518160060160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550905050505050505050565b600080600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614156115725734670de0b6b3a7640000840214151561157157600080fd5b5b8333600154604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c010000000000000000000000000281526014018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c01000000000000000000000000028152601401828152602001935050505060405180910390206001900490506080604051908101604052806001151581526020016000151581526020018481526020013373ffffffffffffffffffffffffffffffffffffffff168152506004600083815260200190815260200160002060008201518160000160006101000a81548160ff02191690831515021790555060208201518160000160016101000a81548160ff0219169083151502179055506040820151816001015560608201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550905050600180600082825401925050819055507f90890809c654f11d6e72a28fa60149770a0d11ec6c92319d6ceb2bb0a4ea1a15338483604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001838152602001828152602001935050505060405180910390a18091505092915050565b611790613354565b611798613354565b6117a0613354565b600080600560008a815260200190815260200160002060000160009054906101000a900460ff1615156117d257600080fd5b611889600560008b81526020019081526020016000206003018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561187f5780601f106118545761010080835404028352916020019161187f565b820191906000526020600020905b81548152906001019060200180831161186257829003601f168201915b5050505050612177565b9450611942600560008b81526020019081526020016000206005018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156119385780601f1061190d57610100808354040283529160200191611938565b820191906000526020600020905b81548152906001019060200180831161191b57829003601f168201915b5050505050612177565b935061194d88612177565b92508260200151856020015114151561196557600080fd5b8260400151856040015114151561197b57600080fd5b876040518082805190602001908083835b6020831015156119b1578051825260208201915060208101905060208303925061198c565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020915060036000878152602001908152602001600020549050611a118982898560001916612283909392919063ffffffff16565b1515611a1c57600080fd5b600560008a81526020019081526020016000206002015486118015611a745750826080015173ffffffffffffffffffffffffffffffffffffffff16856060015173ffffffffffffffffffffffffffffffffffffffff16145b15611aa457600560008a815260200190815260200160002060000160006101000a81549060ff0219169055611c20565b600560008a81526020019081526020016000206002015486108015611afc5750826080015173ffffffffffffffffffffffffffffffffffffffff16846060015173ffffffffffffffffffffffffffffffffffffffff16145b15611b2c57600560008a815260200190815260200160002060000160006101000a81549060ff0219169055611c1f565b600560008a815260200190815260200160002060040154861015611c1e57611b6f88600660008c815260200190815260200160002061234e90919063ffffffff16565b1515611c1d57600660008a81526020019081526020016000206060604051908101604052806001151581526020018a8152602001888152509080600181540180825580915050906001820390600052602060002090600302016000909192909190915060008201518160000160006101000a81548160ff0219169083151502179055506020820151816001019080519060200190611c0e9291906133b0565b50604082015181600201555050505b5b5b5b505050505050505050565b611c33613354565b611c3b613354565b600080611c6388600660008c815260200190815260200160002061234e90919063ffffffff16565b1515611c6e57600080fd5b600560008a815260200190815260200160002060000160009054906101000a900460ff161515611c9d57600080fd5b611ca688612177565b9350611cb187612177565b925082602001518460200151141515611cc957600080fd5b82604001518460400151141515611cdf57600080fd5b826080015173ffffffffffffffffffffffffffffffffffffffff16846060015173ffffffffffffffffffffffffffffffffffffffff16141515611d2157600080fd5b600560008a8152602001908152602001600020600401548511151515611d4657600080fd5b866040518082805190602001908083835b602083101515611d7c5780518252602082019150602081019050602083039250611d57565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020915060036000868152602001908152602001600020549050611ddc8982888560001916612283909392919063ffffffff16565b1515611de757600080fd5b611e0c88600660008c815260200190815260200160002061238a90919063ffffffff16565b50505050505050505050565b60025481565b60046020528060005260406000206000915090508060000160009054906101000a900460ff16908060000160019054906101000a900460ff16908060010154908060020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905084565b60006005600083815260200190815260200160002060000160009054906101000a900460ff161515611eb957600080fd5b60056000838152602001908152602001600020600101544210151515611ede57600080fd5b600090505b6006600083815260200190815260200160002080549050811015611f59576006600083815260200190815260200160002081815481101515611f2157fe5b906000526020600020906003020160000160009054906101000a900460ff16151515611f4c57600080fd5b8080600101915050611ee3565b6005600083815260200190815260200160002060060160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc670de0b6b3a76400006004600086815260200190815260200160002060010154029081150290604051600060405180830381858888f19350505050158015611ff5573d6000803e3d6000fd5b506005600083815260200190815260200160002060000160006101000a81549060ff02191690555050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60066020528160005260406000208181548110151561206057fe5b9060005260206000209060030201600091509150508060000160009054906101000a900460ff1690806001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156121205780601f106120f557610100808354040283529160200191612120565b820191906000526020600020905b81548152906001019060200180831161210357829003601f168201915b5050505050908060020154905083565b6000612157826006600086815260200190815260200160002061234e90919063ffffffff16565b905092915050565b60036020528060005260406000206000915090505481565b61217f613354565b606061219d600561218f8561258c565b6125bf90919063ffffffff16565b905060a0604051908101604052806121cc8360008151811015156121bd57fe5b90602001906020020151612655565b81526020016121f28360018151811015156121e357fe5b90602001906020020151612655565b815260200161221883600281518110151561220957fe5b90602001906020020151612655565b815260200161223e83600381518110151561222f57fe5b9060200190602002015161267f565b73ffffffffffffffffffffffffffffffffffffffff168152602001612262836126b2565b73ffffffffffffffffffffffffffffffffffffffff16815250915050919050565b600080600080879150602090505b8451811115156123365780850151925060006002888115156122af57fe5b0614156122eb5781836040518083600019166000191681526020018260001916600019168152602001925050506040518091039020915061231c565b8282604051808360001916600019168152602001826000191660001916815260200192505050604051809103902091505b60028781151561232857fe5b049650602081019050612291565b85600019168260001916149350505050949350505050565b60008061235b84846127ee565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81141591505092915050565b600080612395613430565b61239f85856127ee565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156123d25760009250612584565b8460018680549050038154811015156123e757fe5b9060005260206000209060030201606060405190810160405290816000820160009054906101000a900460ff16151515158152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156124b55780601f1061248a576101008083540402835291602001916124b5565b820191906000526020600020905b81548152906001019060200180831161249857829003601f168201915b5050505050815260200160028201548152505090508085838154811015156124d957fe5b906000526020600020906003020160008201518160000160006101000a81548160ff02191690831515021790555060208201518160010190805190602001906125239291906133b0565b506040820151816002015590505084600186805490500381548110151561254657fe5b906000526020600020906003020160000160006101000a81549060ff02191690556001858181805490500391508161257e9190613454565b50600192505b505092915050565b612594613486565b6000808351915060208401905060408051908101604052808281526020018381525092505050919050565b60606125c96134a0565b60008360405190808252806020026020018201604052801561260557816020015b6125f26134c1565b8152602001906001900390816125ea5790505b50925061261185612916565b91505b8381101561264d576126258261294a565b838281518110151561263357fe5b906020019060200201819052508080600101915050612614565b505092915050565b60008060006126638461298e565b8092508193505050806020036101000a82510492505050919050565b60008061268b8361298e565b905080915050601481111515156126a157600080fd5b6126aa83612655565b915050919050565b60006060600060608060046040519080825280602002602001820160405280156126f057816020015b60608152602001906001900390816126db5790505b509350600092505b600483101561274957612721868481518110151561271257fe5b906020019060200201516129fb565b848481518110151561272f57fe5b9060200190602002018190525082806001019350506126f8565b61275284612a68565b915061277586600481518110151561276657fe5b90602001906020020151612a8d565b90506127e3826040518082805190602001908083835b6020831015156127b0578051825260208201915060208101905060208303925061278b565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902082612af4565b945050505050919050565b600080606080600092505b85805490508310156128e957858381548110151561281357fe5b90600052602060002090600302016001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156128b85780601f1061288d576101008083540402835291602001916128b8565b820191906000526020600020905b81548152906001019060200180831161289b57829003601f168201915b5050505050915084905060006128ce8383612bec565b14156128dc5782935061290d565b82806001019350506127f9565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff93505b50505092915050565b61291e6134a0565b600061292983612e98565b83600001510190508282600001819052508082602001818152505050919050565b612952613486565b6000808360200151915061296582612f24565b905081836000018181525050808360200181815250508082018460200181815250505050919050565b600080600080600085600001519150815160001a925060808310156129b957819450600193506129f3565b60b88310156129d757600186602001510393506001820194506129f2565b60b78303905080600187602001510303935060018183010194505b5b505050915091565b6060600080836020015191506000821415612a1557612a61565b816040519080825280601f01601f191660200182016040528015612a485781602001602082028038833980820191505090505b509250602083019050612a6081856000015184612fbe565b5b5050919050565b6060806060612a7684613009565b9150612a81826130fb565b90508092505050919050565b60606000806000612a9d8561298e565b8093508194505050816040519080825280601f01601f191660200182016040528015612ad85781602001602082028038833980820191505090505b509350602084019050612aec818484612fbe565b505050919050565b60008060008060418551141515612b0e5760009350612be3565b6020850151925060408501519150606085015160001a9050601b8160ff161015612b3957601b810190505b601b8160ff1614158015612b515750601c8160ff1614155b15612b5f5760009350612be3565b600186828585604051600081526020016040526040518085600019166000191681526020018460ff1660ff1681526020018360001916600019168152602001826000191660001916815260200194505050505060206040516020810390808403906000865af1158015612bd6573d6000803e3d6000fd5b5050506020604051035193505b50505092915050565b6000806000845191508184511015612c0357835191505b600090505b81811015612e46578381815181101515612c1e57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19168582815181101515612c9957fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19161015612d34577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9250612e90565b8381815181101515612d4257fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19168582815181101515612dbd57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19161115612e395760019250612e90565b8080600101915050612c08565b835185511015612e78577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9250612e90565b835185511115612e8b5760019250612e90565b600092505b505092915050565b60008060008084602001511415612eb25760009250612f1d565b83600001519050805160001a91506080821015612ed25760009250612f1d565b60b8821080612eee575060c08210158015612eed575060f882105b5b15612efc5760019250612f1d565b60c0821015612f1357600160b78303019250612f1d565b600160f783030192505b5050919050565b600080825160001a90506080811015612f405760019150612fb8565b60b8811015612f5757600160808203019150612fb7565b60c0811015612f815760b78103806020036101000a60018501510480820160010193505050612fb6565b60f8811015612f9857600160c08203019150612fb5565b60f78103806020036101000a600185015104808201600101935050505b5b5b5b50919050565b60005b602082101515612fe65782518452602084019350602083019250602082039150612fc1565b6001826020036101000a0390508019835116818551168181178652505050505050565b606060008060606000606060008094505b875185101561304d57878581518110151561303157fe5b906020019060200201515186019550848060010195505061301a565b856040519080825280601f01601f1916602001820160405280156130805781602001602082028038833980820191505090505b509350602084019250600094505b87518510156130ed5787858151811015156130a557fe5b9060200190602002015191506020820190506130c383828451612fbe565b87858151811015156130d157fe5b906020019060200201515183019250848060010195505061308e565b839650505050505050919050565b60606000606060008060008060208801955087519250600090505b82610100820210156131375781806001019250508080600101915050613116565b6037831115156131f557600183016040519080825280601f01601f1916602001820160405280156131775781602001602082028038833980820191505090505b5094508260c0017f0100000000000000000000000000000000000000000000000000000000000000028560008151811015156131af57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053506021850193506131f0848785612fbe565b613346565b8282600101016040519080825280601f01601f19166020018201604052801561322d5781602001602082028038833980820191505090505b50945060018260f801037f01000000000000000000000000000000000000000000000000000000000000000285600081518110151561326857fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600190505b8181111515613332576101008183036101000a848115156132ba57fe5b048115156132c457fe5b067f01000000000000000000000000000000000000000000000000000000000000000285828151811015156132f557fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350808060010191505061329d565b8160218601019350613345848785612fbe565b5b849650505050505050919050565b60a060405190810160405280600081526020016000815260200160008152602001600073ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff1681525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106133f157805160ff191683800117855561341f565b8280016001018555821561341f579182015b8281111561341e578251825591602001919060010190613403565b5b50905061342c91906134db565b5090565b60606040519081016040528060001515815260200160608152602001600081525090565b815481835581811115613481576003028160030283600052602060002091820191016134809190613500565b5b505050565b604080519081016040528060008152602001600081525090565b6060604051908101604052806134b46134c1565b8152602001600081525090565b604080519081016040528060008152602001600081525090565b6134fd91905b808211156134f95760008160009055506001016134e1565b5090565b90565b61354891905b8082111561354457600080820160006101000a81549060ff0219169055600182016000613533919061354b565b600282016000905550600301613506565b5090565b90565b50805460018160011615610100020316600290046000825580601f106135715750613590565b601f01602090049060005260206000209081019061358f91906134db565b5b505600a165627a7a72305820d81da2ea61bcd263475cc8c55f8b61ed7e3791afb326991eb542e0ac331b6dd90029"

        # Create the contract_data folder if it doesn't already exist
        os.makedirs('contract_data', exist_ok=True)

        contract_file = open('contract_data/%s.json' % (file_name.split('.')[0]), "w+")
        json.dump(abi, contract_file)
        contract_file.close()
        return abi, bytecode, contract_name

    def deploy_contract(self, path, args=(), gas=4410000):
        abi, bytecode, contract_name = self.compile_contract(path, args)
        contract = w3.eth.contract(abi=abi, bytecode=bytecode)

        address = w3.toChecksumAddress(plasma_config['AUTHORITY'].hex())
        key = plasma_config['AUTHORITY_KEY']
        tx = contract.constructor().buildTransaction({
            'from': address,
            'nonce': w3.eth.getTransactionCount(address, 'pending')
        })
        signed = w3.eth.account.signTransaction(tx, key)
        tx_hash = w3.eth.sendRawTransaction(signed.rawTransaction)
        tx_receipt = w3.eth.waitForTransactionReceipt(tx_hash)

        print('Successfully deployed {} contract with tx hash {} in contract address {}!'.format(
            contract_name, tx_hash.hex(), tx_receipt.contractAddress))

    def get_contract(self, path):
        file_name = path.split('/')[1]
        abi = json.load(open('contract_data/%s.json' % (file_name.split('.')[0])))
        contract = w3.eth.contract(
            address=w3.toChecksumAddress(plasma_config['ROOT_CHAIN_CONTRACT_ADDRESS']),
            abi=abi
        )
        return contract
